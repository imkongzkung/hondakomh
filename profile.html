<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô | Honda</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .container { max-width: 800px; margin: 40px auto; padding: 20px; font-family: 'Kanit'; }
        .profile-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #ddd; }
        .booking-card { background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .booking-card h3 { margin: 0 0 10px 0; color: #cc0000; }
        .booking-info { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px; color: #555; }
        .logout-btn { background: #333; color: #fff; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>
    <header>
        <a href="index.html" class="logo-link"><img src="https://upload.wikimedia.org/wikipedia/commons/7/7b/Honda_Logo.svg" alt="Honda" class="logo-icon"></a>
        <a href="index.html" style="text-decoration:none; color:black;">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
    </header>

    <div class="container">
        <div class="profile-header">
            <h1 id="welcome-msg">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ...</h1>
            <button class="logout-btn" onclick="logout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>

        <h2>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á Test Drive ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h2>
        <div id="booking-list">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
    </div>

    <script>
        const user = JSON.parse(localStorage.getItem('user'));

        if (!user) {
            alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô');
            window.location.href = 'login.html';
        } else {
            document.getElementById('welcome-msg').innerText = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ ‡∏Ñ‡∏∏‡∏ì ${user.fullname}`;
            loadMyBookings();
        }

        async function loadMyBookings() {
    try {
        // 1. ‡∏î‡∏∂‡∏á Token ‡∏°‡∏≤‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏ß‡πâ
        const token = localStorage.getItem('token');
        
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ Token ‡πÉ‡∏´‡πâ‡πÑ‡∏•‡πà‡πÑ‡∏õ Login
        if (!token) {
            alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô');
            window.location.href = 'login.html';
            return;
        }

        // 2. [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç] 
        // - ‡∏•‡∏ö ${user.id} ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å URL (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÑ‡∏õ‡∏ó‡∏µ‡πà /api/my-bookings ‡πÄ‡∏â‡∏¢‡πÜ)
        // - ‡πÄ‡∏û‡∏¥‡πà‡∏° headers Authorization ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á Token
        const res = await fetch('/api/my-bookings', { 
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + token // <--- ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
            }
        });

        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ Server ‡∏ï‡∏≠‡∏ö‡∏≠‡∏∞‡πÑ‡∏£‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
        if (res.status === 401 || res.status === 403) {
            alert('Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ Login ‡πÉ‡∏´‡∏°‡πà');
            window.location.href = 'login.html';
            return;
        }

        if(!res.ok) {
            // ‡∏î‡∏π Error ‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡∏ß‡πà‡∏≤‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£
            const errData = await res.json(); 
            throw new Error(errData.message || 'Network response was not ok');
        }

        const bookings = await res.json();
        
        // --- ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ---
        const list = document.getElementById('booking-list'); // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÉ‡∏ô HTML ‡∏°‡∏µ ID ‡∏ô‡∏µ‡πâ‡∏à‡∏£‡∏¥‡∏á‡πÑ‡∏´‡∏°
        if (!list) return; // ‡∏Å‡∏±‡∏ô Error ‡∏ñ‡πâ‡∏≤‡∏´‡∏≤ Element ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠

        list.innerHTML = '';

        if(bookings.length === 0) {
            list.innerHTML = '<p style="text-align:center; color:#666;">‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</p>';
            return;
        }

        bookings.forEach(booking => {
            // ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
            const dateObj = new Date(booking.appointment_date);
            const dateStr = dateObj.toLocaleDateString('th-TH', { day: 'numeric', month: 'long', year: 'numeric' });
            
            const card = document.createElement('div');
            card.className = 'booking-card';
            card.innerHTML = `
                <h3>üöó ${booking.car_model}</h3>
                <div class="booking-info">
                    <div><strong>‡∏™‡∏≤‡∏Ç‡∏≤:</strong> ${booking.branch_name}</div>
                    <div><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> ${dateStr}</div>
                    <div><strong>‡πÄ‡∏ß‡∏•‡∏≤:</strong> ${booking.appointment_time}</div>
                    <div style="margin-top:5px; color:#666; font-size:0.9em;">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏£‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</div>
                </div>
            `;
            list.appendChild(card);
        });

    } catch(err) {
        console.error(err);
        alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ: ' + err.message);
    }
}
function logout() {
    Swal.fire({
        title: '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: '‡πÉ‡∏ä‡πà',
        cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
    }).then((result) => {
        if (result.isConfirmed) {
            // ‚úÖ ‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏•‡∏ö Token ‡∏ó‡∏¥‡πâ‡∏á
            localStorage.removeItem('token');
            localStorage.removeItem('user'); 
            
            // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤
            Swal.fire('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß', '', 'success').then(() => {
                window.location.href = 'index.html'; // ‡∏´‡∏£‡∏∑‡∏≠ login.html
            });
        }
    });
}
// ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ï‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
document.addEventListener('DOMContentLoaded', loadMyBookings);
    </script>
</body>
</html>